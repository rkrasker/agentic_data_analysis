# Code Activity Log: 2026-01-27

**Session:** Codex (GPT-5)
**Focus:** Fix difficulty-tier saturation + add realism imperfections + validate pipeline sample

---

## Summary

Implemented the Instruction 006 fixes for difficulty saturation and rendering realism:

1. **Path completeness tendency wired** into level selection with randomized, higher‑echelon‑biased dropping.
2. **Difficulty tier logic updated** to respect collision zones and structural resolvability (no universal any‑complete short‑circuit).
3. **Confounders made independent** with 15% rate.
4. **Imperfections applied** to rendered raw text (typos, abbreviation inconsistency, corrections, incomplete unit, column bleed).
5. **Rendering realism overhaul (Instruction 007)** — per-level label omission with familiarity boost, value abbreviation, delimiter mixing, and style spec updates.
6. **Added missing archetypes** in style spec: `colonial_district`, `defense_operations`.

Ran unit tests and pipeline samples; canonical.parquet produced and inspected.

---

## Files Modified

| File | Changes |
|------|---------|
| `src/synthetic/renderer.py` | Added tendency retention mapping, biased drop logic, and imperfection application helpers |
| `src/synthetic/difficulty_computer.py` | Replaced `_assign_tier` logic per Instruction 006 |
| `src/synthetic/vocabulary_injector.py` | Confounder gate independent; rate set to 0.15 |
| `tests/synthetic/test_difficulty_saturation_fix.py` | Added unit tests for tendency, tier logic, confounder independence, imperfections |
| `src/synthetic/models.py` | Added `label_omission_rate` and `value_abbreviation_rate` to UnitFormat |
| `src/synthetic/clerk_factory.py` | Parsed and varied new unit_format fields |
| `src/synthetic/renderer.py` | Added label omission, value abbreviation, delimiter mixing, familiarity boost |
| `docs/components/synthetic_data_generation/synthetic_style_spec_v4.1.yaml` | Added new unit_format fields; added missing archetypes |

---

## Tests Run

```bash
PYTHONPATH=. /Users/Eli/.venvs/primary311/bin/pytest tests/synthetic/test_difficulty_saturation_fix.py
```

Result: **4 passed**

---

## Pipeline Sample Run

```bash
venv/bin/python -m src.synthetic.pipeline --output-dir data/synthetic --target-records 200 --seed 42
venv/bin/python -m src.preprocessing.preprocessing_adapter --input data/synthetic/raw.parquet --output data/synthetic/canonical.parquet
```

Generation stats (200 records):
- Total soldiers: 66
- Difficulty distribution: easy 48.5%, moderate 27.3%, hard 15.2%, extreme 9.1%

Later rerun (to surface tier-4/5 records):

```bash
venv/bin/python -m src.synthetic.pipeline --output-dir data/synthetic --target-records 1000 --seed 42
venv/bin/python -m src.preprocessing.preprocessing_adapter --input data/synthetic/raw.parquet --output data/synthetic/canonical.parquet
```

Note: Arrow emitted sysctl warnings about CPU flags (sandboxed env); no effect on outputs.

---

## Data Inspection

- Displayed canonical.parquet rows for soldiers `S0031` and `S0008`.
- Joined canonical records with raw quality tiers for `S0008`.
- Inspected validation.parquet states for `S0008`.

Observation: **records still appear too clean** compared to real‑world data; realism tuning remains a gap.
Observation (post-007): label omission/abbreviation/mixed delimiters now visible; still tuning needed.

---

## Related Instructions

- Implemented: `instructions/completed/006_fix-difficulty-saturation.md`
- Implemented: `instructions/completed/007_rendering-realism-overhaul.md`
