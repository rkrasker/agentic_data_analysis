# Code Activity Log: 2026-01-29

**Session:** Codex (GPT-5)
**Focus:** Implement ADR-010 synthetic metadata separation + difficulty prefixes; implement Instructions 011-014 for ADR-009 resolver alignment

---

## Summary

Implemented Instruction 010 and ADR-010 schema separation:

1. **Separated core vs synthetic metadata** in synthetic pipeline outputs.
2. **Added ground-truth difficulty module** (`gt_*`) for post-hoc computation.
3. **Prefixed inferred difficulty outputs** and added a CLI writer.
4. **Updated preprocessing adapter** to align with new raw schema and synthetic records passthrough.
5. **Updated tests and documentation** to match new schema and prefixes.

Implemented Instruction 011 difficulty-based sampling:

6. **Added preprocessing split module** to emit train/test parquet with difficulty labels joined.
7. **Added stratified sampling by difficulty tier** with quota redistribution and fallbacks.
8. **Updated resolver generation** to use precomputed train split and difficulty stratification.
9. **Added targeted tests** for split preparation and stratified sampling behavior.

Implemented ADR-009 resolver generation alignment (Instructions 012-014):

10. **Deterministic Phase 5 exclusions** with hierarchy-derived discriminators (no LLM calls).
11. **Three-layer hard case criteria** across prompts, parsing, reconciliation, and resolver meta.
12. **Branch-aware structure encoding** with variable depths/levels and updated hierarchy rules.

---

## Files Modified

| File | Changes |
|------|---------|
| `src/difficulty/ground_truth.py` | New ground-truth difficulty computation (gt_* outputs) |
| `src/difficulty/__init__.py` | Exported ground-truth difficulty utilities |
| `src/synthetic/pipeline.py` | Split outputs into raw/validation/synthetic_records/synthetic_soldiers + gt_difficulty |
| `src/preprocessing/difficulty/compute.py` | Inferred prefixes + inferred writer CLI |
| `src/preprocessing/difficulty/__init__.py` | Exported inferred writer |
| `src/preprocessing/preprocessing_adapter.py` | Updated raw schema + synthetic_records passthrough |
| `tests/test_difficulty_compute.py` | Updated assertions for inferred_* |
| `tests/test_resolver_validation.py` | Merged synthetic_records for quality tiers |
| `docs/components/synthetic_data_generation/CURRENT.md` | Updated schema + ADR-010 status |
| `docs/components/preprocessing/CURRENT.md` | Updated input/output contract |
| `docs/architecture/CURRENT.md` | Updated artifacts list |
| `DIFFICULTY_MODEL.md` | Noted state_id synthetic-only in canonical |
| `SESSION_STATE.md` | Marked ADR-010 implementation complete |
| `src/preprocessing/splits/prepare_train_split.py` | New train/test split prep with difficulty join |
| `src/preprocessing/splits/__init__.py` | Exported split preparation helper |
| `src/strategies/resolver/generator/sampling.py` | Added difficulty stratification + tier weights |
| `src/strategies/resolver/generator/generate.py` | Support precomputed train split + stratified sampling |
| `tests/preprocessing/test_prepare_train_split.py` | Added split preparation tests |
| `tests/strategies/resolver/generator/test_sampling_stratified.py` | Added stratified sampling tests |
| `src/strategies/resolver/generator/structure.py` | Branch-aware structure extraction + deterministic exclusions |
| `src/strategies/resolver/generator/llm_phases.py` | Deterministic exclusions; hierarchy rules updated for branch-aware structures |
| `src/strategies/resolver/generator/prompts.py` | Three-layer hard case criteria + schema updates |
| `src/strategies/resolver/generator/dual_run.py` | Hard case layer parsing + dataclass updates |
| `src/strategies/resolver/generator/reconciliation.py` | Hard case layer analysis + summaries |
| `src/strategies/resolver/generator/assembler.py` | Branch-aware structure section + exclusions schema update |
| `src/strategies/resolver/generator/registry.py` | Exclusions status updated to not_applicable |

---

## Tests Run

Not run (pytest not available in environment).

---

## Notes

- Inferred difficulty outputs retain prior auxiliary columns with new `inferred_` prefixes:
  `inferred_candidate_branches`, `inferred_level_confidences`, `inferred_eliminating_constraints`.
- `gt_difficulty.parquet` is computed post-generation inside the synthetic pipeline.
